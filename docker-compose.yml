# Default: build and run for Apple Silicon (M1/M2/M3/M4). Override with:
#   docker compose build --platform linux/amd64
#   docker compose up --build
services:
  world_embeddings:
    build: .
    platform: linux/arm64
    container_name: world_embeddings_node
    command: >
      ros2 launch world_embeddings world_embeddings.launch.py
      params_file:=/ros_ws/install/world_embeddings/share/world_embeddings/config/params.e2e.yaml
    volumes:
      - e2e_output:/data
    environment:
      - ROS_DOMAIN_ID=0

  e2e_test:
    build: .
    platform: linux/arm64
    container_name: world_embeddings_e2e
    depends_on:
      - world_embeddings
    volumes:
      - e2e_output:/data
    environment:
      - ROS_DOMAIN_ID=0
      - SNAPSHOT_PATH=/data/snapshot.json
    command: >
      bash -c "
        echo 'Waiting for node to be ready...' &&
        sleep 5 &&
        python3 /ros_ws/src/world_embeddings/scripts/run_e2e.py
      "
    restart: "no"

volumes:
  e2e_output:
